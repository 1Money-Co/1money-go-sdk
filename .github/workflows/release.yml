# Copyright 2025 1Money Co.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Release

on:
  push:
    branches:
      - main
      - ryan/fix-release-workflow
    tags:
      - "v*.*.*"

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-release-pr:
    name: Prepare release PR
    if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/ryan/fix-release-workflow'
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          else
            # Test mode on branch
            SHORT_SHA="${GITHUB_SHA:0:7}"
            TAG="v0.0.0-test-${SHORT_SHA}"
            VERSION="0.0.0-test-${SHORT_SHA}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Preparing release PR for $TAG (version: $VERSION)"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version.go
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/const Version = \".*\"/const Version = \"$VERSION\"/" version.go
          echo "Updated version.go:"
          cat version.go

      - name: Generate changelog
        id: changelog_file
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --tag ${{ steps.version.outputs.tag }}
        env:
          OUTPUT: CHANGELOG.md

      - name: Check for modifications
        id: changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No updates detected, skipping PR creation."
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            git status -sb
          fi

      - name: Create release PR
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(release): bump version to ${{ steps.version.outputs.version }}"
          branch: release/${{ steps.version.outputs.tag }}
          title: "chore(release): ${{ steps.version.outputs.tag }}"
          body: |
            Automated release preparation for `${{ steps.version.outputs.tag }}`.

            - Update `version.go`
            - Refresh `CHANGELOG.md`
          add-paths: |
            version.go
            CHANGELOG.md
          labels: release
          assignees: ${{ github.actor }}

  publish-release:
    name: Publish GitHub release
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ryan/fix-release-workflow'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect release commit
        id: release
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-parse "${AFTER}^" 2>/dev/null || echo "")"
          fi

          if [ -z "$BEFORE" ]; then
            echo "No previous commit to compare against; skipping release."
            echo "run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if git diff --quiet "$BEFORE" "$AFTER" -- version.go; then
            echo "version.go not changed in this push; skipping release."
            echo "run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          VERSION=$(sed -n 's/^const Version = "\(.*\)"/\1/p' version.go)
          if [ -z "$VERSION" ]; then
            echo "Unable to determine version from version.go" >&2
            exit 1
          fi

          echo "Detected release version $VERSION"
          echo "run=true" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Configure git
        if: steps.release.outputs.run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update release tag
        if: steps.release.outputs.run == 'true'
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          git fetch origin --tags
          git tag -a "$TAG" -f -m "Release $TAG"
          git push origin "$TAG" --force
          echo "âœ… Tag $TAG now points to $(git rev-parse --short HEAD)"

      - name: Get previous tag
        if: steps.release.outputs.run == 'true'
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        if: steps.release.outputs.run == 'true'
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: >-
            ${{ steps.prev_tag.outputs.tag && format('{0}..{1}', steps.prev_tag.outputs.tag, steps.release.outputs.tag) || steps.release.outputs.tag }}
        env:
          OUTPUT: /tmp/RELEASE_CHANGELOG.md

      - name: Create GitHub Release
        if: steps.release.outputs.run == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: ${{ contains(steps.release.outputs.tag, '-alpha') || contains(steps.release.outputs.tag, '-beta') || contains(steps.release.outputs.tag, '-rc') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update pkg.go.dev
        if: steps.release.outputs.run == 'true'
        run: |
          curl -s "https://proxy.golang.org/github.com/1Money-Co/1money-go-sdk/@v/${{ steps.release.outputs.tag }}.info" || true
